<apt-breadcrumb [label]="'CART.CREATE_ORDER' | translate" [breadcrumbs]="breadcrumbs" [autoGenerated]="false">
  <app-action-bar></app-action-bar>
</apt-breadcrumb>
<ng-container *ngIf="cart">
<div class="container-fluid px-5 py-4" id="checkout-form">
  <!-- <apt-mini-profile #profile></apt-mini-profile> -->

  <h4 class="mb-3 text-muted">{{'CART.CREATE_ORDER' | translate}}</h4>
  <div *ngIf="!isPayForOrderEnabled; else paymentForm" class="row">
    <div class="col-md-4 order-md-2 mb-4">
      <apt-price-summary [paymentState]="paymentState" [record]="cart" [form]="form"
        [page]="pricingSummaryType" [loading]="loading" (onSubmitOrder)="submitOrder()" #priceSummary>
        <button type="button" class="btn btn-link cancel-button w-100" [routerLink]="['/carts/active']" (click)="loader=true" [ladda]="loader" data-style="zoom-in">{{'COMMON.CANCEL' | translate}}</button>
      </apt-price-summary>
      <cart-summary [cart]="cart"></cart-summary>
    </div>
    <div class="col-md-8 order-md-1">
      <!-- <div class="card p-3 d-flex justify-content-between" *ngIf="!isLoggedIn">
        <span>
          <a href="javascript:void(0)" (click)="profile.openModal('second')">{{'CART.LOG_IN' | translate}}</a>
          &nbsp;{{'CART.LOGIN_FOR_FASTER_CHECKOUT' | translate}}
        </span>
      </div> -->
      <!-- <div class="mb-3" [ngClass]="isLoggedIn ? 'mt-2' : 'mt-4'">
        <h5 class="mb-0 text-muted">{{'CART.BILLING_AND_SHIPPING_INFORMATION' | translate}}</h5>
        <small>{{'CART.ENTER_SHIPPING_ADDRESS' | translate}}</small>
      </div> -->
      <form class="needs-validation" novalidate #form="ngForm">
        <div class="card p-3">
          <!-- <tabset #staticTabs *ngIf="primaryContact"> -->
            <!-- <tab heading="{{'CART.BILLING_ADDRESS' | translate}}" id="billing"> -->

              <!-- <div *ngIf="!isLoggedIn; else showBillingAddressTemplate">
                <div class="row mt-3">
                  <div class="col-md-6 mb-3">
                    <apt-input-field name="firstName" [labelClass]="'font-weight-normal'" [entity]="primaryContact"
                      [field]="'FirstName'" [required]="true" [(ngModel)]="primaryContact.FirstName"
                      [errorMsg]="errMessages.requiredFirstName">
                    </apt-input-field>
                  </div>
                  <div class="col-md-6 mb-3">
                    <apt-input-field name="lastName" [labelClass]="'font-weight-normal'" [entity]="primaryContact"
                      [field]="'LastName'" [required]="true" [(ngModel)]="primaryContact.LastName"
                      [errorMsg]="errMessages.requiredLastName">
                    </apt-input-field>
                  </div>
                </div>

                <div class="mb-3">
                  <apt-input-field name="email" [labelClass]="'font-weight-normal'" [placeholder]="'you@example.com'"
                    [entity]="primaryContact" [field]="'Email'" [required]="true" [(ngModel)]="primaryContact.Email"
                    [errorMsg]="errMessages.requiredEmail">
                  </apt-input-field>
                </div>

                <apt-address [(ngModel)]="primaryContact" type="Billing" name="billingAddress" [form]="form">
                </apt-address>
              </div> -->

              <!-- <ng-template #showBillingAddressTemplate>
              </ng-template> -->
              <div class="pt-3 px-3">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <apt-input-field name="description" [labelClass]="'font-weight-normal'" [entity]="order"
                      [field]="'Description'" [(ngModel)]="order.Description" [label]="'Order Title'">
                    </apt-input-field>
                  </div>
                  <div class="col-md-6 mb-3">
                    <apt-output-field [record]="order" field="PriceListId" [labelClass]="'font-weight-normal'" [editable]="false" [showQuickView]="true">
                    </apt-output-field>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <apt-output-field [record]="order" field="SoldToAccountId" [labelClass]="'font-weight-normal'" [editable]="false" [showQuickView]="true">
                    </apt-output-field>
                  </div>
                  <div class="col-md-6 mb-3">
                    <apt-input-field name="primaryContact" [labelClass]="'font-weight-normal'" [entity]="order"
                      [field]="'PrimaryContactId'" [(ngModel)]="order.PrimaryContactId" (ngModelChange)="onPrimaryContactChange()" [lookupOptions]="lookupOptions" [required]="true" [errorMsg]="errMessages.requiredPrimaryContact">
                    </apt-input-field>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <apt-input-field name="billTo" [labelClass]="'font-weight-normal'" [entity]="order"
                      [field]="'BillToAccountId'" [(ngModel)]="order.BillToAccountId" (ngModelChange)="onBillToChange()">
                    </apt-input-field>
                    <apt-output-field [record]="billToAccount$ | async" field="BillingAddress"
                      [labelClass]="'font-weight-normal'" [editable]="false">
                    </apt-output-field>
                  </div>
                  <div class="col-md-6 mb-3">
                    <apt-input-field name="shipTo" [labelClass]="'font-weight-normal'" [entity]="order"
                      [field]="'ShipToAccountId'" [(ngModel)]="order.ShipToAccountId" (ngModelChange)="onShipToChange()"
                      [required]="true" [errorMsg]="errMessages.requiredShipToAcc">
                    </apt-input-field>
                    <apt-output-field [record]="shipToAccount$ | async" field="ShippingAddress"
                      [labelClass]="'font-weight-normal'" [editable]="false">
                    </apt-output-field>
                  </div>
                </div>
              </div>
            <!-- </tab> -->
            <!-- <tab heading="{{'CART.SHIPPING_ADDRESS' | translate}}" [disabled]="shippingEqualsBilling" id="shipping"> -->
              <!-- <div *ngIf="!isLoggedIn; else showShippingAddressTemplate">
                <apt-address [(ngModel)]="primaryContact" type="Shipping" name="shippingAddress" class="mt-3 d-block"
                  [form]="form"></apt-address>
              </div> -->

              <!-- <ng-template #showShippingAddressTemplate>
              </ng-template> -->
              <!-- <div class="pt-3 px-3">
                <apt-input-field name="shipTo" [labelClass]="'font-weight-normal'" [entity]="cart"
                  [field]="'ShipToAccountId'" [(ngModel)]="model.shipToAccountId" (ngModelChange)="onShipToChange()">
                </apt-input-field>
                <apt-output-field [record]="shipToAccount$ | async" field="ShippingAddress"
                  [labelClass]="'font-weight-normal'" [editable]="false"></apt-output-field>
              </div> -->
            <!-- </tab> -->
          <!-- </tabset> -->

          <!-- <hr class="mb-4">
          <div class="custom-control custom-checkbox">
            <input type="checkbox" class="custom-control-input" id="same-address" (ngModelChange)="selectTab($event)"
              [(ngModel)]="shippingEqualsBilling" name="shippingEqualsBilling">
            <label class="custom-control-label" for="same-address">{{'CART.SHIPPING_AS_BILLING' | translate}}</label>
          </div> -->
        </div>
        <!-- <ng-container *ngIf="isLoggedIn">
          <div class="mt-4 mb-3">
            <h5 class="mb-0 text-muted">Choose a payment method</h5>
          </div>
          <div class="card">
            <div class="d-block">
              <div class="custom-control custom-radio m-3">
                <input name="paymentState" type="radio" id="invoice" class="custom-control-input" [value]="'INVOICE'"
                  required="" [(ngModel)]="paymentState">
                <label class="custom-control-label" for="invoice">Invoice Me Later</label>
              </div>
              <div class="custom-control custom-radio m-3">
                <input name="paymentState" type="radio" id="ponumber" class="custom-control-input" [value]="'PONUMBER'"
                  [(ngModel)]="paymentState">
                <label class="custom-control-label" for="ponumber">{{ 'CART.PAYMENT.PONUMBER' | translate }}</label>
                <div class="form-group" *ngIf="paymentState === 'PONUMBER'">
                  <input type="text" class="form-control" id="poNumber" placeholder="Enter a purchase order number..."
                    [(ngModel)]="order.Apttus_Config2__PONumber__c" name="poNumber">
                </div>
              </div>
              <div class="custom-control custom-radio m-3">
                <input name="paymentState" type="radio" id="paynow" class="custom-control-input" [value]="'PAYNOW'"
                  [(ngModel)]="paymentState">
                <label class="custom-control-label" for="paynow">Pay Now</label>
              </div>
            </div>
          </div>
        </ng-container> -->
      </form>
    </div>
  </div>


</div>

<ng-template #confirmationTemplate>
  <div class="modal-header align-items-center p-0 mx-4 mt-3 border-bottom border-secondary">
    <h6 class="modal-title pull-left font-weight-bold">
      {{'MANAGE_CART.CART_SUMMARY.CHECKOUT' | translate}}
    </h6>
    <button type="button" class="close pull-right" aria-label="Close" (click)="confirmationModal.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body d-flex flex-column justify-content-center py-4">
    <p class="text-center"><strong>{{ 'QUOTE_CONFIRMATION_MODAL.THANK_YOU' | translate }}
        {{primaryContact?.FirstName}}!</strong></p>
    <small class="text-center" [translate]="'CART.SUCCESSFUL_ORDER_CREATION_MESSAGE'"
      [translateParams]="{emailAddress: primaryContact?.Email}"></small>
    <h5 class="text-center my-3" [translate]="'DETAILS.GENERATED_ORDER_NUMBER'"
      [translateParams]="{orderName: orderConfirmation?.Name}"></h5>
    <button class="btn btn-outline-primary w-25 mx-auto"
      (click)="closeModal()">{{ 'DETAILS.VIEW_YOUR_ORDER' | translate }}</button>
  </div>
</ng-template>

<ng-template #paymentForm>
  <div *ngIf="!isPaymentCompleted; else paymentCompletionTemplate" class="row">
    <div class="col-md-4 order-md-2 mb-4">
      <apt-price-summary [paymentState]="paymentState" [record]="orderConfirmation"  [loading]="loading" [page]="pricingSummaryType"
        (onPaymentRequest)="submitPayment()" #priceSummary>
      </apt-price-summary>
    </div>
    <div class="col-md-8 order-md-1">   
      <apt-payment
        [paymentTransaction]="paymentTransaction"
        *ngIf="paymentState === 'PAYNOW'" (onSelectingPayment)='onSelectingPaymentMethod($event)'
        (onPaymentComplete)='onPaymentComplete($event)'>
      </apt-payment>
      <apt-payment-iframe hidden *ngIf="paymentState === 'PAYNOW' && isMakePaymentRequest"
        [paymentTransaction]="paymentTransaction"
        [paymentType]="'SilentSale'" (onSubmitPaymentRequest)='onPaymentComplete($event)'>
      </apt-payment-iframe>
    </div>
  </div>
</ng-template>

<ng-template #paymentCompletionTemplate>
  <div  class="card row">
    <div class="p-3 justify-content-between">
      <span>
        <div class="d-flex flex-column justify-content-center py-4">
          <p class="text-center"><strong>{{ 'QUOTE_CONFIRMATION_MODAL.THANK_YOU' | translate }}
              {{primaryContact.FirstName}}!</strong></p>
              <small class="text-center">{{ 'CART.PAYMENT.SUCCESSFUL_PAYMENT_ORDER_MESSAGE' | translate }}</small>
          <small class="text-center" [translate]="'CART.PAYMENT.SUCCESSFUL_PAYMENT_ORDER_MESSAGE_SubTitle'"
            [translateParams]="{emailAddress: primaryContact.Email}"></small>
          <h5 class="text-center my-3" [translate]="'DETAILS.GENERATED_ORDER_NUMBER'"
            [translateParams]="{orderName: orderConfirmation?.Name}"></h5>
          <button class="btn btn-outline-primary w-25 mx-auto"
            (click)="redirectOrderPage()">{{ 'DETAILS.VIEW_YOUR_ORDER' | translate }}</button>
        </div>
      </span>
    </div>
  </div>
</ng-template>
</ng-container>